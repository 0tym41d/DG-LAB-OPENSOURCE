## 郊狼情趣电击器V3

### 蓝牙特性
|    服务UUID    |    特性UUID     |      属性      |      名称      |    大小(BYTE)  | 说明 |
| :------------: | :------------: | :------------: | :------------: | :------------: | :----: |
|     0x180C     |     0x150A     |    写     | WRITE        | 最长20字节           | 所有的指令都在该特性输入 |
|     0x180C     |     0x150B     |    通知   | NOTIFY        | 最长20字节           | 所有的回调消息都在该特性返回 |

> 基础UUID：0000`xxxx`-0000-1000-8000-00805f9b34fb(将xxxx替换为服务/特性UUID)

### 基本原理
郊狼内置了两组独立的脉冲生成模块，分别对应A，B两个通道。每组脉冲生成模块又由通道强度和通道波形数据两部分构成。我们通过蓝牙协议中的通道强度，波形频率，波形强度，波形频率平衡参数，波形强度平衡参数 五个个变量来控制脉冲生成模块

### 蓝牙指令

#### B0指令
B0指令写入通道强度变化和通道波形数据,指令数据长度为20字节，每100ms写入。
```
0xB0(1byte指令HEAD)+序列号(4bits)+强度值解读方式(4bits)+A通道强度设定值(1byte)+B通道强度设定值(1byte)+A通道波形频率4条(4bytes)+A通道波形强度4条(4bytes)+B通道波形频率4条(4bytes)+B通道波形强度4条(4bytes)
```
##### 序列号
序列号范围(0b0000 ~ 0b1111),如果输入的数据中修改了电击器的通道强度，设置序列号 >0,电击器会将修改后的通道强度从特性0x150B返回，如果不需要电击器反馈通道强度，则序列号设置0b0000即可。

##### 强度值解读方式
强度值解读方式的4bits分为两个部分，高两位bits代表A通道解读方式，低两位bits代表B通道解读方式。
解读方式:
0b00 -> 代表对应通道强度不做改变，对应通道的强度设定值无论是什么都无效
0b01 -> 代表对应通道强度相对增加变化，若A通道强度设定值为15(10进制)，那么A通道强度增加15
0b10 -> 代表对应通道强度相对减少变化，若A通道强度设定值为17(10进制)，那么A通道强度减少17
0b11 -> 代表对应通道强度绝对变化，若A通道强度设定值为32，那么A通道强度设置为32

>e.g<br/>假设当前电击器的A通道强度为10，B通道强度为10。<br/>1.  强度值解读方式=0b0000，A通道强度设定值=5，B通道强度设置定=8，B0指令输入后，电击器的A通道强度 = 10，B通道强度 = 10<br/>2. 强度值解读方式=0b0100，A通道强度设定值=5，B通道强度设定值=8，B0指令输入后，电击器的A通道强度 = 15，B通道强度 = 10<br/>3. 强度值解读方式=0b0010，A通道强度设定值=5，B通道强度设定值=8，B0指令输入后，电击器的A通道强度 = 10，B通道强度 = 2<br/>4. 强度值解读方式=0b0011，A通道强度设定值=5，B通道强度设定值=8，B0指令输入后，电击器的A通道强度 = 10，B通道强度 = 8<br/>5. 强度值解读方式=0b0110，A通道强度设定值=5，B通道强度设定值=8，B0指令输入后，电击器的A通道强度 = 15，B通道强度 = 2<br/>6. 强度值解读方式=0b1101，A通道强度设定值=5，B通道强度设定值=8，B0指令输入后，电击器的A通道强度 = 5，B通道强度 = 18

##### 通道强度设定值
通道强度设定值长度为1字节，值有效范围(0 ~ 200),输入范围外的值均以0处理。且电击器内的通道强度范围也是(0 ~ 200)。
>e.g<br/>假设当前电击器的A通道强度为10<br/>1. 强度值解读方式=0b0100，A通道强度设定值=195，B0指令输入后，电击器的A通道强度 = 200<br/>2. 强度值解读方式=0b1000，A通道强度设定值=20，B0指令输入后，电击器的A通道强度 = 0<br/>3. 强度值解读方式=0b0100，A通道强度设定值=195，B0指令输入后，电击器的A通道强度 = 200<br/>4. 强度值解读方式=0b0100，A通道强度设定值=201，B0指令输入后，电击器的A通道强度 = 10<br/>5. 强度值解读方式=0b1100，A通道强度设定值=201，B0指令输入后，电击器的A通道强度 = 0<br/>

##### 通道波形频率/通道波形强度
通道波形频率长度1byte,值范围(10 ~ 240)，通道波形强度1byte，值范围(0 ~ 100)
在B0指令中，每100ms要发送两通道的4组波形频率和波形强度，每组频率-强度代表了25ms的波形输出，4组数据代表了100ms数据。
在波形数据中，若某通道的输入值不在有效范围，则电击器会放弃掉该通道全部4组数据。

>e.g<br/>以下举例A通道波形数据<br/>1. 波形频率4条={10,10,20,30}，波形强度={0,5,10,50}，B0指令输入后，A通道正常输出波形<br/>2. 波形频率4条={10,10,20,30}，波形强度={0,5,10,101}，B0指令输入后，A通道放弃全部4组数据，不输出波形

- Tips 如果当前只想向单个通道输出波形，则将另一个通道的数据中输入至少一个非有效数据(一条大于100的波形强度值)，如上e.g所示。

#### BF指令
BF指令写入电击器的通道强度软上限+波形频率平衡参数+波形强度平衡参数，指令数据长度为7字节。
```
0xBF(1byte指令HEAD)+AB两通道强度软上限(2bytes)+AB两通道波形频率平衡参数(2btyes)+AB两通道波形强度平衡参数(2bytes)
```
##### 通道强度软上限
通道强度软上限可以限制电击器通道强度能达到的最大值，并且该设置断电保存，值范围(0 ~ 200)，输入范围外的值则不会修改软上限。
假设设置AB通道软上限为150和30，那么通过B0指令无论如何修改强度，A通道的通道强度只会在范围(0 ~ 150),B通道的通道强度只会在范围(0 ~ 30)，电击器的通道强度一定不会超过软上限。

##### 波形频率平衡参数
波形频率平衡参数会调整波形高低频的感受，并且该设置断电保存，值范围(0 ~ 255)
loading...

##### 波形强度平衡参数
波形强度平衡参数会调整波形脉冲宽度，并且该设置断电保存，值范围(0 ~ 255)
loading...

### 蓝牙数据回调
电击器所有的数据回调都通过0x180C->0x150B的特性Notify返回，请在成功连接电击器后对该特性绑定notify。

#### B1指令

B1指令返回B0输入的序列号以及当前电击器的通道强度值。在电击器输出波形的过程中，拨动电击器两侧的拨轮修改强度或者通过B0指令修改强度导致电击器强度发生变化时，会立刻返回B1。
```
0xB1(1byte指令HEAD)+序列号(1byte)+A通道当前实际强度(1byte)+B通道当前实际强度(1byte)
```

#### BE指令

BE指令返回BF输入的对应设置后电击器当前的AB通道强度软上限+AB通道波形频率平衡参数+AB通道波形强度平衡参数。
```
0xBE(1byte指令HEAD)+AB两通道强度软上限(2bytes)+AB两通道波形频率平衡参数(2btyes)+AB两通道波形强度平衡参数(2bytes)
```
